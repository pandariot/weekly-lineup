import { useState, useRef, useEffect } from "react";

const PUZZLES = [
  {
    id: "spotify", cat: "SPOTIFY", icon: "ğŸ¤", color: "#1DB954",
    prompt: "Most monthly listeners on Spotify right now", dir: "most to fewest monthly listeners",
    items: [
      { name: "The Weeknd", val: "115.2M listeners", s: 1152 },
      { name: "Taylor Swift", val: "97.8M listeners", s: 978 },
      { name: "Billie Eilish", val: "82.4M listeners", s: 824 },
      { name: "Bad Bunny", val: "71.6M listeners", s: 716 },
      { name: "Sabrina Carpenter", val: "64.3M listeners", s: 643 },
    ],
  },
  {
    id: "box_office", cat: "BOX OFFICE", icon: "ğŸ¬", color: "#E50914",
    prompt: "Highest grossing at the box office this weekend", dir: "highest to lowest gross",
    items: [
      { name: "Dune: Part Three", val: "$82.4M", s: 824 },
      { name: "Captain America: Brave New World", val: "$45.1M", s: 451 },
      { name: "Bridget Jones: Mad About the Boy", val: "$22.3M", s: 223 },
      { name: "The Monkey", val: "$14.7M", s: 147 },
      { name: "Paddington in Peru", val: "$8.9M", s: 89 },
    ],
  },
  {
    id: "google", cat: "MOST GOOGLED", icon: "ğŸ”", color: "#4285F4",
    prompt: "Most Googled people this week", dir: "most to fewest searches",
    items: [
      { name: "Taylor Swift", val: "12.4M searches", s: 124 },
      { name: "Travis Kelce", val: "9.8M searches", s: 98 },
      { name: "Zendaya", val: "7.2M searches", s: 72 },
      { name: "Pete Davidson", val: "5.6M searches", s: 56 },
      { name: "Ice Spice", val: "3.1M searches", s: 31 },
    ],
  },
  {
    id: "billboard", cat: "BILLBOARD", icon: "ğŸµ", color: "#FF6B35",
    prompt: "Highest on the Hot 100 this week", dir: "highest to lowest chart position",
    items: [
      { name: "Die With A Smile â€“ Gaga & Mars", val: "#1", s: 100 },
      { name: "APT. â€“ ROSÃ‰ & Bruno Mars", val: "#3", s: 98 },
      { name: "Lovers & Friends â€“ Usher", val: "#5", s: 96 },
      { name: "Luther â€“ Kendrick & SZA", val: "#7", s: 94 },
      { name: "Timeless â€“ Weeknd & Carti", val: "#9", s: 92 },
    ],
  },
  {
    id: "wikipedia", cat: "WIKIPEDIA", icon: "ğŸŒ", color: "#636466",
    prompt: "Most viewed on Wikipedia this week", dir: "most to fewest pageviews",
    items: [
      { name: "Conan O'Brien", val: "4.8M views", s: 48 },
      { name: "Severance (TV series)", val: "3.2M views", s: 32 },
      { name: "Super Bowl LX", val: "2.9M views", s: 29 },
      { name: "TimothÃ©e Chalamet", val: "2.1M views", s: 21 },
      { name: "Bird flu", val: "1.7M views", s: 17 },
    ],
  },
];

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

const F = "'Instrument Sans', 'Helvetica Neue', sans-serif";
const M = "'JetBrains Mono', 'SF Mono', monospace";

export default function TheLineup() {
  const [screen, setScreen] = useState("menu");
  const [pz, setPz] = useState(null);
  const [items, setItems] = useState([]);
  const [att, setAtt] = useState(1);
  const [fb, setFb] = useState(null);
  const [hist, setHist] = useState([]);
  const [win, setWin] = useState(false);
  const [copied, setCopied] = useState(false);
  const [done, setDone] = useState([]);
  const [allRes, setAllRes] = useState({});
  const [dragIdx, setDragIdx] = useState(null);
  const [dragDy, setDragDy] = useState(0);
  const startY = useRef(0);
  const rowH = useRef(72);
  const refs = useRef([]);

  const unlocked = done.length;

  const go = (p) => {
    setPz(p);
    setItems(shuffle(p.items.map((it, i) => ({ ...it, idx: i, id: "i" + i }))));
    setAtt(1); setFb(null); setHist([]); setWin(false); setCopied(false); setDragIdx(null);
    setScreen("play");
  };

  const submit = () => {
    const res = items.map((it, i) => {
      const ci = pz.items.findIndex((c) => c.name === it.name);
      const d = Math.abs(i - ci);
      return { ...it, diff: d, em: d === 0 ? "ğŸŸ©" : "ğŸŸ¥" };
    });
    const perfect = res.every((r) => r.diff === 0);
    setFb(res);
    const newHist = [...hist, res.map((r) => r.em)];
    setHist(newHist);

    if (perfect) {
      setWin(true);
      setTimeout(() => {
        setAllRes((p) => ({ ...p, [pz.id]: { win: true, att: newHist.length, grid: newHist } }));
        setDone((p) => [...p, pz.id]);
        setScreen("result");
      }, 1200);
    } else if (att >= 3) {
      setTimeout(() => {
        setItems(pz.items.map((it, i) => ({ ...it, idx: i, id: "i" + i })));
        setFb(pz.items.map((it) => ({ ...it, diff: 0, em: "ğŸŸ©" })));
        setTimeout(() => {
          setAllRes((p) => ({ ...p, [pz.id]: { win: false, att: 3, grid: newHist } }));
          setDone((p) => [...p, pz.id]);
          setScreen("result");
        }, 1200);
      }, 1500);
    } else {
      setAtt((p) => p + 1);
      setTimeout(() => setFb(null), 1800);
    }
  };

  // Pointer drag
  const onDown = (e, i) => {
    if (fb) return;
    e.preventDefault();
    const el = refs.current[i];
    if (el) rowH.current = el.getBoundingClientRect().height + 8;
    setDragIdx(i);
    startY.current = e.clientY;
    setDragDy(0);
  };

  useEffect(() => {
    if (dragIdx === null) return;
    let ci = dragIdx;
    let sy = startY.current;

    const onMove = (e) => {
      e.preventDefault();
      const dy = e.clientY - sy;
      setDragDy(dy);
      const th = rowH.current * 0.5;
      if (dy > th && ci < items.length - 1) {
        setItems((prev) => {
          const n = [...prev];
          const tmp = n[ci];
          n[ci] = n[ci + 1];
          n[ci + 1] = tmp;
          return n;
        });
        ci++;
        setDragIdx(ci);
        sy += rowH.current;
        startY.current = sy;
        setDragDy(dy - rowH.current);
      } else if (dy < -th && ci > 0) {
        setItems((prev) => {
          const n = [...prev];
          const tmp = n[ci];
          n[ci] = n[ci - 1];
          n[ci - 1] = tmp;
          return n;
        });
        ci--;
        setDragIdx(ci);
        sy -= rowH.current;
        startY.current = sy;
        setDragDy(dy + rowH.current);
      }
    };

    const onUp = () => {
      setDragIdx(null);
      setDragDy(0);
    };

    document.addEventListener("pointermove", onMove, { passive: false });
    document.addEventListener("pointerup", onUp);
    document.addEventListener("pointercancel", onUp);
    return () => {
      document.removeEventListener("pointermove", onMove);
      document.removeEventListener("pointerup", onUp);
      document.removeEventListener("pointercancel", onUp);
    };
  }, [dragIdx, items.length]);

  const copyText = async (txt) => {
    try { await navigator.clipboard.writeText(txt); } catch (_e) { /* noop */ }
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const shareOne = () => {
    const grid = hist.map((r, i) => (i + 1) + ". " + r.join("")).join("\n");
    const r = win ? "âœ… Solved in " + hist.length + "/3!" : "âŒ 3/3";
    copyText("THE LINEUP: " + pz.cat + "\n" + pz.prompt + "\n\n" + grid + "\n" + r + "\n\nPlay at buzzfeed.com/the-lineup");
  };

  const shareAll = () => {
    const lines = ["THE LINEUP ğŸ¯\n"];
    PUZZLES.forEach((p) => {
      const r = allRes[p.id];
      if (!r) return;
      const row = r.grid[r.grid.length - 1].join("");
      lines.push(p.icon + " " + p.cat + ": " + row + " " + (r.win ? "âœ… " + r.att + "/3" : "âŒ"));
    });
    lines.push("\n" + Object.values(allRes).filter((r) => r.win).length + "/5 rounds solved");
    lines.push("\nPlay at buzzfeed.com/the-lineup");
    copyText(lines.join("\n"));
  };

  const Badge = ({ color, children }) => (
    <span style={{ display: "inline-flex", alignItems: "center", gap: 8, background: color + "20", border: "1px solid " + color + "40", borderRadius: 100, padding: "6px 16px", fontFamily: M, fontSize: 11, letterSpacing: "0.12em", textTransform: "uppercase", color }}>{children}</span>
  );

  const Btn = ({ bg, color, onClick, children, style }) => (
    <button onClick={onClick} style={{ background: bg || "#FAFAFA", color: color || "#0A0A0A", border: "none", borderRadius: 14, padding: "16px 32px", fontSize: 15, fontWeight: 700, fontFamily: F, cursor: "pointer", ...style }}>{children}</button>
  );

  const Wrap = ({ children }) => (
    <div style={{ minHeight: "100vh", background: "#0A0A0A", color: "#FAFAFA", fontFamily: F, display: "flex", flexDirection: "column", alignItems: "center", padding: "0 16px", touchAction: "pan-x" }}>
      <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
      <div style={{ width: "100%", maxWidth: 480, textAlign: "center", paddingTop: 40, marginBottom: 24 }}>
        <div style={{ fontSize: 13, fontFamily: M, letterSpacing: "0.2em", color: "#666", textTransform: "uppercase", marginBottom: 4 }}>BuzzFeed Presents</div>
        <h1 style={{ fontSize: 32, fontWeight: 800, letterSpacing: "-0.02em", margin: 0 }}>THE LINEUP</h1>
      </div>
      {children}
    </div>
  );

  // â•â•â•â•â•â• MENU â•â•â•â•â•â•
  if (screen === "menu") {
    const allDone = done.length === PUZZLES.length;
    return (
      <Wrap>
        <p style={{ color: "#666", fontSize: 14, marginTop: -16, marginBottom: 16 }}>
          {allDone ? "All rounds complete!" : "Rank 5 items. 3 attempts. 5 rounds."}
        </p>
        {done.length > 0 && !allDone && (
          <div style={{ fontFamily: M, fontSize: 12, color: "#555", marginBottom: 16 }}>Round {done.length + 1} of 5</div>
        )}
        <div style={{ width: "100%", maxWidth: 480, display: "flex", flexDirection: "column", gap: 12 }}>
          {PUZZLES.map((p, i) => {
            const isDone = done.includes(p.id);
            const isNext = i === unlocked;
            const locked = i > unlocked;
            const r = allRes[p.id];
            return (
              <div key={p.id} onClick={() => isNext && go(p)} style={{
                background: p.color + "12", border: "1.5px solid " + p.color + (isNext ? "60" : "20"),
                borderRadius: 16, padding: "20px 24px", display: "flex", alignItems: "center", gap: 16,
                cursor: isNext ? "pointer" : "default", opacity: locked ? 0.35 : 1, transition: "all 0.2s",
              }}>
                <div style={{ fontSize: 32, width: 56, height: 56, display: "flex", alignItems: "center", justifyContent: "center", borderRadius: 14, background: "rgba(255,255,255,0.06)" }}>{p.icon}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontFamily: M, fontSize: 11, letterSpacing: "0.15em", textTransform: "uppercase", color: "#888", marginBottom: 2 }}>{p.cat}</div>
                  <div style={{ fontSize: 15, fontWeight: 600, lineHeight: 1.3, color: "#E0E0E0" }}>{p.prompt}</div>
                  {isDone && r && (
                    <div style={{ display: "flex", gap: 3, marginTop: 6, alignItems: "center" }}>
                      {r.grid[r.grid.length - 1].map((em, j) => <span key={j} style={{ fontSize: 14 }}>{em}</span>)}
                      <span style={{ fontSize: 11, color: "#888", fontFamily: M, marginLeft: 6 }}>{r.win ? r.att + "/3" : "x/3"}</span>
                    </div>
                  )}
                </div>
                <div style={{ color: isDone ? "#22c55e" : "#555", fontSize: 20, flexShrink: 0 }}>
                  {isDone ? "âœ“" : isNext ? "â†’" : "ğŸ”’"}
                </div>
              </div>
            );
          })}
        </div>
        {allDone && (
          <div style={{ marginTop: 24 }}>
            <Btn bg="#CDFF00" onClick={shareAll}>{copied ? "âœ“ Copied!" : "ğŸ“‹ Share All Results"}</Btn>
          </div>
        )}
        <p style={{ color: "#333", fontSize: 12, fontFamily: M, marginTop: 32 }}>New puzzles every Monday</p>
      </Wrap>
    );
  }

  // â•â•â•â•â•â• RESULT â•â•â•â•â•â•
  if (screen === "result") {
    return (
      <Wrap>
        <div style={{ width: "100%", maxWidth: 480, textAlign: "center", paddingBottom: 60 }}>
          <div style={{ fontSize: 56, marginBottom: 16 }}>{win ? "ğŸ¯" : "ğŸ˜¤"}</div>
          <div style={{ fontSize: 28, fontWeight: 800, marginBottom: 8 }}>{win ? "Nailed it in " + hist.length + "!" : "Better luck next time"}</div>
          <div style={{ marginBottom: 24 }}><Badge color={pz.color}>{pz.icon} {pz.cat}</Badge></div>

          <div style={{ marginBottom: 24 }}>
            {hist.map((row, i) => (
              <div key={i} style={{ display: "flex", justifyContent: "center", gap: 6, marginBottom: 6 }}>
                {row.map((em, j) => <span key={j} style={{ fontSize: 28 }}>{em}</span>)}
              </div>
            ))}
          </div>

          <div style={{ textAlign: "left", marginTop: 32, marginBottom: 24 }}>
            <div style={{ fontFamily: M, fontSize: 11, letterSpacing: "0.15em", textTransform: "uppercase", color: "#555", marginBottom: 12 }}>Correct order â€” {pz.dir}</div>
            {pz.items.map((it, i) => (
              <div key={i} style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 0", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
                <div style={{ fontFamily: M, fontSize: 13, color: "#555", width: 24 }}>#{i + 1}</div>
                <div style={{ flex: 1, fontSize: 14, fontWeight: 600 }}>{it.name}</div>
                <div style={{ fontFamily: M, fontSize: 13, color: pz.color, fontWeight: 600 }}>{it.val}</div>
              </div>
            ))}
          </div>

          <Btn bg={pz.color} color="#fff" onClick={shareOne}>{copied ? "âœ“ Copied!" : "ğŸ“‹ Share Results"}</Btn>
          <br />
          {done.length < PUZZLES.length ? (
            <Btn onClick={() => {
              const ni = PUZZLES.findIndex((p) => p.id === pz.id) + 1;
              if (ni < PUZZLES.length) go(PUZZLES[ni]); else setScreen("menu");
            }} style={{ width: "100%", marginTop: 12, marginBottom: 40, padding: "16px 0" }}>Next round â†’</Btn>
          ) : (
            <Btn bg="#CDFF00" onClick={() => setScreen("menu")} style={{ marginTop: 12, marginBottom: 40 }}>See all results â†’</Btn>
          )}
        </div>
      </Wrap>
    );
  }

  // â•â•â•â•â•â• PLAY â•â•â•â•â•â•
  return (
    <Wrap>
      <div style={{ width: "100%", maxWidth: 480 }}>
        <Badge color={pz.color}>{pz.icon} {pz.cat}</Badge>
        <div style={{ fontSize: 20, fontWeight: 700, lineHeight: 1.3, marginTop: 8, marginBottom: 4 }}>{pz.prompt}</div>
        <div style={{ fontSize: 13, color: "#666", fontFamily: M, marginBottom: 24 }}>Drag to rank: {pz.dir}</div>

        <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
          {items.map((item, i) => {
            const f = fb ? fb[i] : null;
            const active = dragIdx === i;
            const green = f && f.em === "ğŸŸ©";
            const red = f && f.em === "ğŸŸ¥";
            return (
              <div
                key={item.id}
                ref={(el) => { refs.current[i] = el; }}
                onPointerDown={(e) => onDown(e, i)}
                style={{
                  background: active ? "rgba(255,255,255,0.1)" : green ? "#22c55e18" : red ? "#ef444418" : "rgba(255,255,255,0.04)",
                  border: "1.5px solid " + (active ? "rgba(255,255,255,0.3)" : green ? "#22c55e40" : red ? "#ef444440" : "rgba(255,255,255,0.08)"),
                  borderRadius: 14, padding: "14px 16px", display: "flex", alignItems: "center", gap: 10,
                  transition: active ? "none" : "all 0.25s cubic-bezier(0.2, 0, 0, 1)",
                  transform: active ? "translateY(" + dragDy + "px) scale(1.03)" : "scale(1)",
                  boxShadow: active ? "0 8px 32px rgba(0,0,0,0.4)" : "none",
                  zIndex: active ? 10 : 1, position: "relative",
                  userSelect: "none", touchAction: "none",
                  cursor: f ? "default" : "grab",
                }}
              >
                {!f && <div style={{ color: active ? "#aaa" : "#555", fontSize: 22, flexShrink: 0, lineHeight: 1 }}>â ¿</div>}
                {f && <div style={{ fontSize: 20, flexShrink: 0 }}>{f.em}</div>}
                <div style={{ fontFamily: M, fontSize: 13, color: "#555", width: 22, flexShrink: 0 }}>{i + 1}.</div>
                <div style={{ flex: 1, fontSize: 15, fontWeight: 600, lineHeight: 1.3 }}>{item.name}</div>
                {f && f.diff === 0 && <div style={{ fontFamily: M, fontSize: 12, color: pz.color, flexShrink: 0 }}>{item.val}</div>}
              </div>
            );
          })}
        </div>

        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 20, marginBottom: 12 }}>
          <div style={{ fontFamily: M, fontSize: 12, color: "#555" }}>Attempt {att}/3</div>
          <div style={{ display: "flex", gap: 8 }}>
            {[0, 1, 2].map((i) => <div key={i} style={{ width: 10, height: 10, borderRadius: "50%", background: i < att ? "#fff" : "rgba(255,255,255,0.15)" }} />)}
          </div>
        </div>

        {!fb && <Btn onClick={submit} style={{ width: "100%", padding: "16px 0" }}>Lock in my order â†’</Btn>}
        {fb && !win && att <= 3 && (
          <div style={{ textAlign: "center", color: "#666", fontSize: 14, fontFamily: M, padding: "12px 0" }}>
            {att > 3 ? "Revealing correct order..." : "Rearrange and try again..."}
          </div>
        )}
        <div style={{ height: 40 }} />
      </div>
    </Wrap>
  );
}
