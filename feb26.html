import React, { useState, useRef, useCallback, useEffect } from 'react';

// â”€â”€â”€ SAMPLE DATA (replaced by admin panel in production) â”€â”€â”€
const SAMPLE_PUZZLES = [
  {
    id: 'spotify', category: 'SPOTIFY', icon: 'ðŸŽ¤', color: '#1DB954',
    prompt: 'Most monthly listeners on Spotify right now', direction: 'most to fewest monthly listeners',
    items: [
      { name: 'The Weeknd', value: '115.2M listeners', sortValue: 1152 },
      { name: 'Taylor Swift', value: '97.8M listeners', sortValue: 978 },
      { name: 'Billie Eilish', value: '82.4M listeners', sortValue: 824 },
      { name: 'Bad Bunny', value: '71.6M listeners', sortValue: 716 },
      { name: 'Sabrina Carpenter', value: '64.3M listeners', sortValue: 643 },
    ],
  },
  {
    id: 'box_office', category: 'BOX OFFICE', icon: 'ðŸŽ¬', color: '#E50914',
    prompt: 'Highest grossing at the box office this weekend', direction: 'highest to lowest gross',
    items: [
      { name: 'Dune: Part Three', value: '$82.4M', sortValue: 824 },
      { name: 'Captain America: Brave New World', value: '$45.1M', sortValue: 451 },
      { name: 'Bridget Jones: Mad About the Boy', value: '$22.3M', sortValue: 223 },
      { name: 'The Monkey', value: '$14.7M', sortValue: 147 },
      { name: 'Paddington in Peru', value: '$8.9M', sortValue: 89 },
    ],
  },
  {
    id: 'google', category: 'MOST GOOGLED', icon: 'ðŸ”', color: '#4285F4',
    prompt: 'Most Googled people this week', direction: 'most to fewest searches',
    items: [
      { name: 'Taylor Swift', value: '12.4M searches', sortValue: 124 },
      { name: 'Travis Kelce', value: '9.8M searches', sortValue: 98 },
      { name: 'Zendaya', value: '7.2M searches', sortValue: 72 },
      { name: 'Pete Davidson', value: '5.6M searches', sortValue: 56 },
      { name: 'Ice Spice', value: '3.1M searches', sortValue: 31 },
    ],
  },
  {
    id: 'billboard', category: 'BILLBOARD', icon: 'ðŸŽµ', color: '#FF6B35',
    prompt: 'Highest on the Hot 100 this week', direction: 'highest to lowest chart position',
    items: [
      { name: 'Die With A Smile â€“ Lady Gaga & Bruno Mars', value: '#1', sortValue: 100 },
      { name: 'APT. â€“ ROSÃ‰ & Bruno Mars', value: '#3', sortValue: 98 },
      { name: 'Lovers & Friends â€“ Usher', value: '#5', sortValue: 96 },
      { name: 'Luther â€“ Kendrick Lamar & SZA', value: '#7', sortValue: 94 },
      { name: 'Timeless â€“ The Weeknd & Playboi Carti', value: '#9', sortValue: 92 },
    ],
  },
  {
    id: 'wikipedia', category: 'WIKIPEDIA', icon: 'ðŸŒ', color: '#636466',
    prompt: 'Most viewed on Wikipedia this week', direction: 'most to fewest pageviews',
    items: [
      { name: 'Conan O\'Brien', value: '4.8M views', sortValue: 48 },
      { name: 'Severance (TV series)', value: '3.2M views', sortValue: 32 },
      { name: 'Super Bowl LX', value: '2.9M views', sortValue: 29 },
      { name: 'TimothÃ©e Chalamet', value: '2.1M views', sortValue: 21 },
      { name: 'Bird flu', value: '1.7M views', sortValue: 17 },
    ],
  },
];

// â”€â”€â”€ UTILS â”€â”€â”€
const shuffleArray = (arr) => {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

const getScoreEmoji = (diff) => {
  if (diff === 0) return 'ðŸŸ©';
  return 'ðŸŸ¥';
};

// â”€â”€â”€ MAIN COMPONENT â”€â”€â”€
export default function TheLineup() {
  const [screen, setScreen] = useState('menu'); // menu | play | result
  const [puzzle, setPuzzle] = useState(null);
  const [items, setItems] = useState([]);
  const [attempt, setAttempt] = useState(1);
  const [maxAttempts] = useState(3);
  const [feedback, setFeedback] = useState(null);
  const [history, setHistory] = useState([]);
  const [solved, setSolved] = useState(false);
  const [dragging, setDragging] = useState(null);
  const [dragOver, setDragOver] = useState(null);
  const [showShare, setShowShare] = useState(false);
  const [copied, setCopied] = useState(false);
  const [touchStart, setTouchStart] = useState(null);
  const [completedRounds, setCompletedRounds] = useState([]);
  const [allResults, setAllResults] = useState({});
  const listRef = useRef(null);

  const currentUnlocked = completedRounds.length; // index of the next playable puzzle

  // Pick a random puzzle on start
  const startGame = (p) => {
    setPuzzle(p);
    setItems(shuffleArray(p.items.map((item, i) => ({ ...item, correctIndex: i, id: `item-${i}` }))));
    setAttempt(1);
    setFeedback(null);
    setHistory([]);
    setSolved(false);
    setShowShare(false);
    setCopied(false);
    setScreen('play');
  };

  const submitGuess = () => {
    const correctOrder = [...puzzle.items];
    const result = items.map((item, i) => {
      const correctIdx = correctOrder.findIndex(c => c.name === item.name);
      return { ...item, diff: Math.abs(i - correctIdx), emoji: getScoreEmoji(Math.abs(i - correctIdx)) };
    });

    const perfect = result.every(r => r.diff === 0);
    setFeedback(result);
    setHistory(prev => [...prev, result.map(r => r.emoji)]);

    if (perfect) {
      setSolved(true);
      setTimeout(() => {
        setAllResults(prev => ({ ...prev, [puzzle.id]: { solved: true, attempts: history.length + 1, grid: [...history, result.map(r => r.emoji)] } }));
        setCompletedRounds(prev => [...prev, puzzle.id]);
        setScreen('result');
      }, 1200);
    } else if (attempt >= maxAttempts) {
      setTimeout(() => {
        setItems(puzzle.items.map((item, i) => ({ ...item, correctIndex: i, id: `item-${i}` })));
        setFeedback(puzzle.items.map((item, i) => ({ ...item, diff: 0, emoji: 'ðŸŸ©' })));
        setTimeout(() => {
          setAllResults(prev => ({ ...prev, [puzzle.id]: { solved: false, attempts: maxAttempts, grid: [...history, result.map(r => r.emoji)] } }));
          setCompletedRounds(prev => [...prev, puzzle.id]);
          setScreen('result');
        }, 1200);
      }, 1500);
    } else {
      setAttempt(prev => prev + 1);
      setTimeout(() => setFeedback(null), 1800);
    }
  };

  // â”€â”€â”€ DRAG HANDLERS (pointer-based for touch+mouse) â”€â”€â”€
  const handleDragStart = (index) => {
    setDragging(index);
  };

  const handleDragEnter = (index) => {
    if (dragging === null || dragging === index) return;
    setDragOver(index);
    const newItems = [...items];
    const dragItem = newItems[dragging];
    newItems.splice(dragging, 1);
    newItems.splice(index, 0, dragItem);
    setItems(newItems);
    setDragging(index);
  };

  const handleDragEnd = () => {
    setDragging(null);
    setDragOver(null);
  };

  // Touch drag
  const handleTouchStart = (e, index) => {
    setDragging(index);
    setTouchStart({ y: e.touches[0].clientY, index });
  };

  const handleTouchMove = useCallback((e) => {
    if (!touchStart || !listRef.current) return;
    e.preventDefault();
    const touch = e.touches[0];
    const listItems = listRef.current.querySelectorAll('[data-drag-item]');
    for (let i = 0; i < listItems.length; i++) {
      const rect = listItems[i].getBoundingClientRect();
      if (touch.clientY >= rect.top && touch.clientY <= rect.bottom && i !== dragging) {
        handleDragEnter(i);
        break;
      }
    }
  }, [touchStart, dragging]);

  const handleTouchEnd = () => {
    setDragging(null);
    setDragOver(null);
    setTouchStart(null);
  };

  useEffect(() => {
    const el = listRef.current;
    if (el) {
      el.addEventListener('touchmove', handleTouchMove, { passive: false });
      return () => el.removeEventListener('touchmove', handleTouchMove);
    }
  }, [handleTouchMove]);

  const shareText = () => {
    if (!puzzle) return '';
    const title = `THE LINEUP: ${puzzle.category}`;
    const grid = history.map((row, i) => `${i + 1}. ${row.join('')}`).join('\n');
    const result = solved ? `âœ… Solved in ${history.length}/${maxAttempts}!` : `âŒ ${maxAttempts}/${maxAttempts}`;
    return `${title}\n${puzzle.prompt}\n\n${grid}\n${result}\n\nPlay at buzzfeed.com/the-lineup`;
  };

  const handleShare = async () => {
    const text = shareText();
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch {
      // fallback
    }
  };

  const handleShareAll = async () => {
    const lines = ['THE LINEUP ðŸŽ¯\n'];
    SAMPLE_PUZZLES.forEach(p => {
      const r = allResults[p.id];
      if (!r) return;
      const lastRow = r.grid[r.grid.length - 1].join('');
      lines.push(`${p.icon} ${p.category}: ${lastRow} ${r.solved ? `âœ… ${r.attempts}/3` : 'âŒ'}`);
    });
    const totalSolved = Object.values(allResults).filter(r => r.solved).length;
    lines.push(`\n${totalSolved}/5 rounds solved`);
    lines.push('\nPlay at buzzfeed.com/the-lineup');
    const text = lines.join('\n');
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch {}
  };

  // â”€â”€â”€ STYLES â”€â”€â”€
  const font = "'Instrument Sans', 'Helvetica Neue', Helvetica, sans-serif";
  const mono = "'JetBrains Mono', 'SF Mono', 'Fira Code', monospace";

  const styles = {
    wrapper: {
      minHeight: '100vh',
      background: '#0A0A0A',
      color: '#FAFAFA',
      fontFamily: font,
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      padding: '0 16px',
    },
    header: {
      width: '100%',
      maxWidth: 480,
      textAlign: 'center',
      paddingTop: 40,
      marginBottom: 24,
    },
    logo: {
      fontSize: 13,
      fontFamily: mono,
      letterSpacing: '0.2em',
      color: '#666',
      textTransform: 'uppercase',
      marginBottom: 4,
    },
    title: {
      fontSize: 32,
      fontWeight: 800,
      letterSpacing: '-0.02em',
      margin: 0,
    },
    menuGrid: {
      width: '100%',
      maxWidth: 480,
      display: 'flex',
      flexDirection: 'column',
      gap: 12,
      marginTop: 16,
    },
    menuCard: (color) => ({
      background: `${color}12`,
      border: `1.5px solid ${color}30`,
      borderRadius: 16,
      padding: '20px 24px',
      display: 'flex',
      alignItems: 'center',
      gap: 16,
      cursor: 'pointer',
      transition: 'all 0.2s',
    }),
    menuIcon: {
      fontSize: 32,
      width: 56,
      height: 56,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      borderRadius: 14,
      background: 'rgba(255,255,255,0.06)',
    },
    menuLabel: {
      fontFamily: mono,
      fontSize: 11,
      letterSpacing: '0.15em',
      textTransform: 'uppercase',
      color: '#888',
      marginBottom: 2,
    },
    menuPrompt: {
      fontSize: 15,
      fontWeight: 600,
      lineHeight: 1.3,
      color: '#E0E0E0',
    },
    playArea: {
      width: '100%',
      maxWidth: 480,
    },
    categoryBadge: (color) => ({
      display: 'inline-flex',
      alignItems: 'center',
      gap: 8,
      background: `${color}20`,
      border: `1px solid ${color}40`,
      borderRadius: 100,
      padding: '6px 16px',
      fontFamily: mono,
      fontSize: 11,
      letterSpacing: '0.12em',
      textTransform: 'uppercase',
      color: color,
      marginBottom: 8,
    }),
    prompt: {
      fontSize: 20,
      fontWeight: 700,
      lineHeight: 1.3,
      marginBottom: 4,
    },
    direction: {
      fontSize: 13,
      color: '#666',
      fontFamily: mono,
      marginBottom: 24,
    },
    dragItem: (isDragging, feedbackItem) => ({
      background: isDragging ? 'rgba(255,255,255,0.08)' : feedbackItem ? `${feedbackItem.emoji === 'ðŸŸ©' ? '#22c55e' : '#ef4444'}18` : 'rgba(255,255,255,0.04)',
      border: isDragging ? '1.5px solid rgba(255,255,255,0.2)' : feedbackItem ? `1.5px solid ${feedbackItem.emoji === 'ðŸŸ©' ? '#22c55e' : '#ef4444'}40` : '1.5px solid rgba(255,255,255,0.08)',
      borderRadius: 14,
      padding: '16px 20px',
      display: 'flex',
      alignItems: 'center',
      gap: 14,
      cursor: feedback ? 'default' : 'grab',
      transition: 'all 0.25s cubic-bezier(0.2, 0, 0, 1)',
      transform: isDragging ? 'scale(1.03)' : 'scale(1)',
      opacity: isDragging ? 0.85 : 1,
      userSelect: 'none',
      touchAction: 'none',
    }),
    dragHandle: {
      color: '#555',
      fontSize: 18,
      flexShrink: 0,
      width: 24,
      textAlign: 'center',
    },
    itemNum: {
      fontFamily: mono,
      fontSize: 13,
      color: '#555',
      width: 20,
      flexShrink: 0,
    },
    itemName: {
      flex: 1,
      fontSize: 15,
      fontWeight: 600,
      lineHeight: 1.3,
    },
    itemValue: {
      fontFamily: mono,
      fontSize: 13,
      color: '#888',
      flexShrink: 0,
    },
    feedbackEmoji: {
      fontSize: 20,
      flexShrink: 0,
    },
    attemptBar: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginTop: 20,
      marginBottom: 12,
    },
    attemptDots: {
      display: 'flex',
      gap: 8,
    },
    dot: (active) => ({
      width: 10,
      height: 10,
      borderRadius: '50%',
      background: active ? '#fff' : 'rgba(255,255,255,0.15)',
      transition: 'background 0.2s',
    }),
    submitBtn: {
      background: '#FAFAFA',
      color: '#0A0A0A',
      border: 'none',
      borderRadius: 14,
      padding: '16px 0',
      width: '100%',
      fontSize: 15,
      fontWeight: 700,
      fontFamily: font,
      cursor: 'pointer',
      letterSpacing: '0.02em',
      transition: 'opacity 0.2s',
    },
    resultArea: {
      width: '100%',
      maxWidth: 480,
      textAlign: 'center',
      paddingBottom: 60,
    },
    resultEmoji: {
      fontSize: 56,
      marginBottom: 16,
    },
    resultTitle: {
      fontSize: 28,
      fontWeight: 800,
      marginBottom: 8,
    },
    resultSub: {
      fontSize: 15,
      color: '#888',
      marginBottom: 32,
    },
    gridRow: {
      display: 'flex',
      justifyContent: 'center',
      gap: 6,
      marginBottom: 6,
    },
    gridEmoji: {
      fontSize: 28,
    },
    shareBtn: (color) => ({
      background: color || '#FAFAFA',
      color: '#0A0A0A',
      border: 'none',
      borderRadius: 14,
      padding: '16px 32px',
      fontSize: 15,
      fontWeight: 700,
      fontFamily: font,
      cursor: 'pointer',
      marginTop: 24,
      transition: 'transform 0.15s',
    }),
    backBtn: {
      background: 'transparent',
      border: '1.5px solid rgba(255,255,255,0.15)',
      borderRadius: 14,
      padding: '14px 32px',
      fontSize: 14,
      fontWeight: 600,
      fontFamily: font,
      color: '#888',
      cursor: 'pointer',
      marginTop: 12,
    },
    answerList: {
      textAlign: 'left',
      marginTop: 32,
      marginBottom: 24,
    },
    answerItem: {
      display: 'flex',
      alignItems: 'center',
      gap: 12,
      padding: '12px 0',
      borderBottom: '1px solid rgba(255,255,255,0.06)',
    },
    answerRank: {
      fontFamily: mono,
      fontSize: 13,
      color: '#555',
      width: 24,
    },
    answerName: {
      flex: 1,
      fontSize: 14,
      fontWeight: 600,
    },
    answerValue: {
      fontFamily: mono,
      fontSize: 13,
      color: '#1DB954',
      fontWeight: 600,
    },
  };

  // â”€â”€â”€ RENDER â”€â”€â”€
  if (screen === 'menu') {
    const allDone = completedRounds.length === SAMPLE_PUZZLES.length;
    return (
      <div style={styles.wrapper}>
        <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
        <div style={styles.header}>
          <div style={styles.logo}>BuzzFeed Presents</div>
          <h1 style={styles.title}>THE LINEUP</h1>
          <p style={{ color: '#666', fontSize: 14, marginTop: 4 }}>
            {allDone ? 'All rounds complete! Share your results.' : 'Rank 5 items. 3 attempts. 5 rounds.'}
          </p>
          {completedRounds.length > 0 && !allDone && (
            <div style={{ fontFamily: mono, fontSize: 12, color: '#555', marginTop: 8 }}>
              Round {completedRounds.length + 1} of 5
            </div>
          )}
        </div>
        <div style={styles.menuGrid}>
          {SAMPLE_PUZZLES.map((p, idx) => {
            const isCompleted = completedRounds.includes(p.id);
            const isNext = idx === currentUnlocked;
            const isLocked = idx > currentUnlocked;
            const result = allResults[p.id];
            return (
              <div
                key={p.id}
                style={{
                  ...styles.menuCard(p.color),
                  opacity: isLocked ? 0.35 : 1,
                  cursor: isNext ? 'pointer' : 'default',
                  borderColor: isNext ? `${p.color}60` : isCompleted ? `${p.color}20` : `${p.color}15`,
                  position: 'relative',
                }}
                onClick={() => isNext && startGame(p)}
                onMouseEnter={e => { if (isNext) { e.currentTarget.style.borderColor = `${p.color}80`; e.currentTarget.style.transform = 'translateY(-2px)'; } }}
                onMouseLeave={e => { if (isNext) { e.currentTarget.style.borderColor = `${p.color}60`; e.currentTarget.style.transform = 'translateY(0)'; } }}
              >
                <div style={styles.menuIcon}>{p.icon}</div>
                <div style={{ flex: 1 }}>
                  <div style={styles.menuLabel}>{p.category}</div>
                  <div style={styles.menuPrompt}>{p.prompt}</div>
                  {isCompleted && result && (
                    <div style={{ display: 'flex', gap: 3, marginTop: 6 }}>
                      {result.grid[result.grid.length - 1].map((emoji, j) => (
                        <span key={j} style={{ fontSize: 14 }}>{emoji}</span>
                      ))}
                      <span style={{ fontSize: 11, color: '#888', fontFamily: mono, marginLeft: 6 }}>
                        {result.solved ? `${result.attempts}/3` : 'x/3'}
                      </span>
                    </div>
                  )}
                </div>
                <div style={{ marginLeft: 'auto', color: '#555', fontSize: 20 }}>
                  {isCompleted ? 'âœ“' : isNext ? 'â†’' : 'ðŸ”’'}
                </div>
              </div>
            );
          })}
        </div>
        {allDone && (
          <div style={{ maxWidth: 480, width: '100%', textAlign: 'center', marginTop: 24 }}>
            <button
              style={styles.shareBtn('#CDFF00')}
              onClick={handleShareAll}
            >
              {copied ? 'âœ“ Copied!' : 'ðŸ“‹ Share All Results'}
            </button>
          </div>
        )}
        <p style={{ color: '#333', fontSize: 12, fontFamily: mono, marginTop: 32, textAlign: 'center' }}>New puzzles every Monday</p>
      </div>
    );
  }

  if (screen === 'result') {
    return (
      <div style={styles.wrapper}>
        <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
        <div style={styles.header}>
          <div style={styles.logo}>BuzzFeed Presents</div>
          <h1 style={styles.title}>THE LINEUP</h1>
        </div>
        <div style={styles.resultArea}>
          <div style={styles.resultEmoji}>{solved ? 'ðŸŽ¯' : 'ðŸ˜¤'}</div>
          <div style={styles.resultTitle}>{solved ? `Nailed it in ${history.length}!` : 'Better luck next time'}</div>
          <div style={styles.resultSub}>
            <span style={styles.categoryBadge(puzzle.color)}>{puzzle.icon} {puzzle.category}</span>
          </div>

          {/* Emoji grid */}
          <div style={{ marginBottom: 24 }}>
            {history.map((row, i) => (
              <div key={i} style={styles.gridRow}>
                {row.map((emoji, j) => (
                  <span key={j} style={styles.gridEmoji}>{emoji}</span>
                ))}
              </div>
            ))}
          </div>

          {/* Correct answers */}
          <div style={styles.answerList}>
            <div style={{ fontFamily: mono, fontSize: 11, letterSpacing: '0.15em', textTransform: 'uppercase', color: '#555', marginBottom: 12 }}>
              Correct order â€” {puzzle.direction}
            </div>
            {puzzle.items.map((item, i) => (
              <div key={i} style={styles.answerItem}>
                <div style={styles.answerRank}>#{i + 1}</div>
                <div style={styles.answerName}>{item.name}</div>
                <div style={{ ...styles.answerValue, color: puzzle.color }}>{item.value}</div>
              </div>
            ))}
          </div>

          <button
            style={styles.shareBtn(puzzle.color)}
            onClick={handleShare}
            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.97)'}
            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
          >
            {copied ? 'âœ“ Copied!' : 'ðŸ“‹ Share Results'}
          </button>
          <br />
          {completedRounds.length < SAMPLE_PUZZLES.length ? (
            <button
              style={{ ...styles.submitBtn, marginTop: 12, marginBottom: 40 }}
              onClick={() => {
                const nextIdx = SAMPLE_PUZZLES.findIndex(p => p.id === puzzle.id) + 1;
                if (nextIdx < SAMPLE_PUZZLES.length) {
                  startGame(SAMPLE_PUZZLES[nextIdx]);
                } else {
                  setScreen('menu');
                }
              }}
            >
              Next round â†’
            </button>
          ) : (
            <button
              style={{ ...styles.shareBtn('#CDFF00'), marginTop: 12, marginBottom: 40 }}
              onClick={() => setScreen('menu')}
            >
              See all results â†’
            </button>
          )}
        </div>
      </div>
    );
  }

  // â”€â”€â”€ PLAY SCREEN â”€â”€â”€
  return (
    <div style={styles.wrapper}>
      <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
      <div style={styles.header}>
        <div style={styles.logo}>BuzzFeed Presents</div>
        <h1 style={styles.title}>THE LINEUP</h1>
      </div>
      <div style={styles.playArea}>
        <div style={styles.categoryBadge(puzzle.color)}>{puzzle.icon} {puzzle.category}</div>
        <div style={styles.prompt}>{puzzle.prompt}</div>
        <div style={styles.direction}>Drag to rank: {puzzle.direction}</div>

        {/* Draggable items */}
        <div ref={listRef} style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
          {items.map((item, index) => (
            <div
              key={item.id}
              data-drag-item
              draggable={!feedback}
              onDragStart={() => handleDragStart(index)}
              onDragEnter={() => handleDragEnter(index)}
              onDragEnd={handleDragEnd}
              onDragOver={(e) => e.preventDefault()}
              onTouchStart={(e) => handleTouchStart(e, index)}
              onTouchEnd={handleTouchEnd}
              style={styles.dragItem(dragging === index, feedback?.[index])}
            >
              {!feedback && <div style={styles.dragHandle}>â ¿</div>}
              {feedback && <div style={styles.feedbackEmoji}>{feedback[index].emoji}</div>}
              <div style={styles.itemNum}>{index + 1}.</div>
              <div style={styles.itemName}>{item.name}</div>
              {feedback && feedback[index].diff === 0 && (
                <div style={{ ...styles.itemValue, color: puzzle.color }}>{item.value}</div>
              )}
            </div>
          ))}
        </div>

        {/* Attempt bar */}
        <div style={styles.attemptBar}>
          <div style={{ fontFamily: mono, fontSize: 12, color: '#555' }}>
            Attempt {attempt}/{maxAttempts}
          </div>
          <div style={styles.attemptDots}>
            {Array.from({ length: maxAttempts }).map((_, i) => (
              <div key={i} style={styles.dot(i < attempt)} />
            ))}
          </div>
        </div>

        {/* Submit / Back */}
        {!feedback && (
          <button
            style={styles.submitBtn}
            onClick={submitGuess}
            onMouseDown={e => e.currentTarget.style.opacity = '0.8'}
            onMouseUp={e => e.currentTarget.style.opacity = '1'}
          >
            Lock in my order â†’
          </button>
        )}
        {feedback && !solved && attempt <= maxAttempts && (
          <div style={{ textAlign: 'center', color: '#666', fontSize: 14, fontFamily: mono, padding: '12px 0' }}>
            {attempt > maxAttempts ? 'Revealing correct order...' : 'Rearrange and try again...'}
          </div>
        )}

        <div style={{ height: 40 }} />
      </div>
    </div>
  );
}
